---
sidebar: sidebar 
permalink: migration/shift-toolkit-migrate-esxi2osv.html 
keywords: netapp, vmware, esxi, vm, migration, openshift, virtualization, redhat, osv 
summary: Migre máquinas virtuales de VMware ESXi a Red Hat OpenShift Virtualization utilizando Shift Toolkit, preparando las máquinas virtuales, convirtiendo los formatos de disco y configurando el entorno de destino. 
---
= Migrar máquinas virtuales de VMware ESXi a Red Hat OpenShift Virtualization
:hardbreaks:
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ../media/


[role="lead"]
Migre máquinas virtuales de VMware ESXi a Red Hat OpenShift Virtualization utilizando Shift Toolkit, preparando las máquinas virtuales, convirtiendo los formatos de disco y configurando el entorno de destino.

El Shift Toolkit permite la migración de máquinas virtuales entre plataformas de virtualización mediante la conversión del formato de disco y la reconfiguración de la red en el entorno de destino.



== Antes de empezar

Verifique que se cumplan los siguientes requisitos previos antes de iniciar la migración.

.Requisitos de virtualización de Red Hat OpenShift
* Punto de conexión del clúster de OpenShift con los siguientes operadores instalados:
+
** Operador de virtualización de OpenShift
** Controlador CSI NetApp Trident
** Estado de Nuevo México


* NetApp Trident CSI configurado con backends y clases de almacenamiento apropiados
* NodeNetworkConfigurationPolicy y NetworkAttachmentDefinitions (NAD) configuradas con las VLAN adecuadas.
* El clúster de OpenShift es accesible a través de la red con las entradas actuales del archivo de host.
* Privilegios de nivel administrador en el clúster
* Archivo Kubeconfig descargado


.Requisitos de VMware
* Los VMDK se colocan en volúmenes individuales (imitando un VMDK en una estructura PVC/PV) utilizando svmotion.
+

NOTE: Esta limitación se eliminará en la próxima versión, en la que se podrá utilizar el controlador NAS-economy para el aprovisionamiento de PVC.

* Las herramientas de VMware se están ejecutando en las máquinas virtuales invitadas.
* Las máquinas virtuales que se van a migrar están en estado de EJECUCIÓN para su preparación.
* Las máquinas virtuales deben estar apagadas antes de iniciar la migración.
* La eliminación de las herramientas de VMware se produce en el hipervisor de destino una vez que las máquinas virtuales se encienden.


.Requisitos de la máquina virtual invitada
* Para máquinas virtuales Windows: utilice las credenciales de administrador local.
* Para máquinas virtuales Linux: utilice un usuario con permisos para ejecutar comandos sudo sin que se le solicite la contraseña.
* Para máquinas virtuales Windows: Monte la ISO de VirtIO en la máquina virtual (descárguela delink:https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/archive-virtio/virtio-win-0.1.271-1/virtio-win-0.1.271.iso["aquí"] )
+

NOTE: El script de preparación utiliza el paquete .msi para instalar los controladores y los agentes invitados de qemu.





== Paso 1: Agregar el sitio de destino (OpenShift)

Agregue el entorno de virtualización de OpenShift de destino al Shift Toolkit.

.Pasos
. Haz clic en *Agregar nuevo sitio* y selecciona *Destino*.
+
.Mostrar ejemplo
[%collapsible]
====
image::shift-toolkit-100.png[Seleccionar destino]

====
. Introduzca los datos del sitio de destino:
+
** *Nombre del sitio*: Proporcione un nombre para el sitio.
** *Hipervisor*: Seleccione OpenShift
** *Ubicación del sitio*: Seleccione la opción predeterminada
** *Conector*: Seleccione la opción predeterminada


. Haga clic en *Continuar*.
+
.Mostrar ejemplo
[%collapsible]
====
image::shift-toolkit-101.png[Detalles del sitio de destino]

====
. Introduzca los detalles de OpenShift:
+
** *Punto de conexión*: Nombre de dominio completo (FQDN) del punto de conexión del clúster de OpenShift (por ejemplo, api.demomidsno.demoval.com)
** *Subir archivo kubeconfig*: Utilice el archivo kubeconfig con permisos mínimos.
+

NOTE: La extensión del archivo debe ser yaml.

+
.Mostrar ejemplo
[%collapsible]
====
image::shift-toolkit-102.png[Detalles de destino de OpenShift]

====


. Haga clic en *Crear sitio*.
+
.Mostrar ejemplo
[%collapsible]
====
image::shift-toolkit-103.png[Creación de destino OpenShift]

====
+

NOTE: El volumen de origen y el de destino serán el mismo, ya que la conversión del formato del disco se produce a nivel de volumen dentro del mismo volumen.





== Paso 2: Crear grupos de recursos

Organice las máquinas virtuales en grupos de recursos para preservar el orden de arranque y las configuraciones de retardo de arranque.

.Antes de empezar
Asegúrese de que los VMDK de las máquinas virtuales se muevan a volúmenes de almacenamiento de datos individuales en una ONTAP SVM recién creada.

.Pasos
. Navegue hasta *Grupos de recursos* y haga clic en *Crear nuevo grupo de recursos*.
. Seleccione el sitio de origen en el menú desplegable y haga clic en *Crear*.
. Proporcione los detalles del grupo de recursos y seleccione el flujo de trabajo:
+
** *Migración basada en clones*: Realiza una migración completa desde el hipervisor de origen al de destino.
** *Conversión basada en clonación*: Convierte el formato del disco al tipo de hipervisor seleccionado.


. Haga clic en *Continuar*.
. Seleccione las máquinas virtuales utilizando la opción de búsqueda.
+

NOTE: La selección de máquinas virtuales para grupos de recursos se basa en la máquina virtual y no en el nivel del almacén de datos.

+
.Mostrar ejemplo
[%collapsible]
====
image::shift-toolkit-104.png[Almacenes de datos asociados a la máquina virtual]

====
+
.Mostrar ejemplo
[%collapsible]
====
image::shift-toolkit-105.png[Detalles del almacén de datos de la máquina virtual]

====
. Detalles de la migración de la actualización:
+
** Seleccionar *Sitio de destino*
** Seleccione *Entrada de OpenShift de destino*
** Seleccione la clase de almacenamiento
+
.Mostrar ejemplo
[%collapsible]
====
image::shift-toolkit-106.png[Detalles de la migración]

====
+

NOTE: El backend de Trident se asignará automáticamente al volumen de origen si solo hay un TBC; sin embargo, si hay varios TBC, se puede seleccionar el backend.



. Configurar el orden de arranque y el retardo de arranque para todas las máquinas virtuales seleccionadas:
+
** *1*: Primera máquina virtual en encenderse
** *3*: Predeterminado
** *5*: Última máquina virtual en encenderse


. Haga clic en *Crear grupo de recursos*.
+
.Mostrar ejemplo
[%collapsible]
====
image::shift-toolkit-107.png[Configuración de detalles de migración]

====


.Resultado
El grupo de recursos está creado y listo para la configuración del plano.



== Paso 3: Crear un plan de migración

Cree un plan maestro para definir el plan de migración, incluyendo la asignación de plataformas, la configuración de red y la configuración de las máquinas virtuales.

.Pasos
. Navegue hasta *Planos* y haga clic en *Crear nuevo plano*.
. Asigne un nombre al plano y configure las asignaciones de host:
+
** Seleccione *Sitio de origen* y el vCenter asociado.
** Seleccione el *Sitio de destino* y el destino de OpenShift asociado.
** Configurar la asignación de clúster y host
+
.Mostrar ejemplo
[%collapsible]
====
image::shift-toolkit-108.png[Detalles del plano]

====


. Seleccione los detalles del grupo de recursos y haga clic en *Continuar*.
. Establezca el orden de ejecución para los grupos de recursos si existen varios grupos.
. Configure la asignación de red a las redes lógicas apropiadas.
+

NOTE: Las definiciones de conexión de red ya deberían estar aprovisionadas dentro del clúster de OpenShift con las opciones de VLAN y troncales adecuadas.  Para la migración de prueba, seleccione "No configurar la red" para evitar conflictos con la red de producción; asigne manualmente la configuración de red después de la conversión.

+
.Mostrar ejemplo
[%collapsible]
====
image::shift-toolkit-109.png[Mapeo de redes]

====
. Revisar las asignaciones de clases de almacenamiento y backend (seleccionadas automáticamente según la selección de la máquina virtual).
+

NOTE: Asegúrese de que los VMDK se muevan mediante svmotion a volúmenes individuales con antelación para que la máquina virtual pueda crearse y encenderse desde el PVC.

. En Detalles de la máquina virtual, seleccione Detalles de configuración y proporcione las credenciales de la cuenta de servicio para cada tipo de sistema operativo:
+
** *Windows*: Utilice un usuario con privilegios de administrador local (también se pueden usar las credenciales de dominio).
** *Linux*: Utilice un usuario que pueda ejecutar comandos sudo sin que se le solicite la contraseña.
+
.Mostrar ejemplo
[%collapsible]
====
image::shift-toolkit-110.png[Selección de configuración]

====
+

NOTE: La selección de configuración le permite seleccionar el formato de la imagen de disco, omitir la anulación de prepareVM y elegir si desea separar el volumen del elemento principal.  Por defecto, la clonación dividida está desactivada y el flujo de trabajo utiliza el formato RAW por defecto.



. Configurar los ajustes de IP:
+
** *No configurar*: Opción predeterminada
** *Conservar IP*: Mantener las mismas direcciones IP del sistema de origen
** *DHCP*: Asignar DHCP a las máquinas virtuales de destino
+
Asegúrese de que las máquinas virtuales estén encendidas durante la fase prepareVM y de que VMware Tools esté instalado.



. Configurar los ajustes de la máquina virtual:
+
** Redimensionar parámetros de CPU/RAM (opcional)
** Modificar el orden de arranque y el retardo de arranque
** *Encendido*: Seleccione esta opción para encender las máquinas virtuales después de la migración (predeterminado: activado).
** *Eliminar VMware Tools*: Eliminar VMware Tools después de la conversión (opción predeterminada: seleccionada)
** *Firmware de la máquina virtual*: BIOS > BIOS y EFI > EFI (automático)
** *Conserve las direcciones MAC*: Mantenga las direcciones MAC para cumplir con los requisitos de licencia.
+

NOTE: Si es necesario conservar el nombre de la interfaz al mismo tiempo que se conserva la dirección MAC, asegúrese de que se creen las reglas udev apropiadas en la máquina virtual de origen.

** *Anulación de cuenta de servicio*: Especifique una cuenta de servicio independiente si es necesario.


. Haga clic en *Continuar*.
. (Opcional) Programe la migración seleccionando una fecha y hora.
+

NOTE: Programe las migraciones con al menos 30 minutos de antelación para dar tiempo a la preparación de la máquina virtual.

. Haz clic en *Crear plano*.


.Resultado
El Shift Toolkit inicia un trabajo prepareVM que ejecuta scripts en las máquinas virtuales de origen para prepararlas para la migración.

.Mostrar ejemplo
[%collapsible]
====
image::shift-toolkit-111.png[Máquinas virtuales preparadas para la migración]

====
El proceso de preparación:

* Inyecta scripts para actualizar los controladores VirtIO, instalar qemu-agent, eliminar las herramientas de VMware, realizar copias de seguridad de los detalles de IP y actualizar fstab.
* Utiliza PowerCLI para conectarse a máquinas virtuales invitadas (Linux o Windows) y actualizar los controladores VirtIO.
* Para máquinas virtuales Windows: Almacena scripts en `C:\NetApp`
* Para máquinas virtuales Linux: Almacena scripts en `/NetApp` y `/opt`



NOTE: Para cualquier sistema operativo de máquina virtual compatible, Shift Toolkit instala automáticamente los controladores VirtIO necesarios antes de la conversión del disco para garantizar un arranque exitoso después de la conversión.

Cuando prepareVM finaliza correctamente, el estado del plano se actualiza a "PrepareVM completado".  La migración se realizará ahora a la hora programada o se puede iniciar manualmente haciendo clic en la opción *Migrar*.

.Mostrar ejemplo
[%collapsible]
====
image::shift-toolkit-112.png[Estado completo de PrepareVM]

====
.Mostrar ejemplo
[%collapsible]
====
image::shift-toolkit-113.png[Plan listo para la migración]

====


== Paso 4: Ejecutar la migración

Inicie el flujo de trabajo de migración para convertir las máquinas virtuales de VMware ESXi a OpenShift Virtualization.

.Antes de empezar
Todas las máquinas virtuales se apagan correctamente según el programa de mantenimiento previsto.

.Pasos
. En el plano, haga clic en *Migrar*.
+
.Mostrar ejemplo
[%collapsible]
====
image::shift-toolkit-114.png[Pasos de migración]

====
. El kit de herramientas Shift realiza los siguientes pasos:
+
** Elimina las instantáneas existentes de todas las máquinas virtuales en el plano.
** Desencadena instantáneas de máquinas virtuales en el origen
** Se activa una instantánea del volumen antes de la conversión del disco.
** Clona los volúmenes individuales
** Convierte cada VMDK a formato RAW.
+
Shift Toolkit encuentra automáticamente todos los VMDK asociados a cada máquina virtual, incluido el disco de arranque principal.






NOTE: Si existen varios archivos VMDK, cada uno de ellos será convertido.  En esta versión (v4.0), cada VMDK debe colocarse en un volumen/almacén de datos individual.

* Limpia los volúmenes para que solo quede el archivo disk.img.
+
Una vez convertida la imagen de disco de la máquina virtual al formato RAW, Shift Toolkit limpia los volúmenes, cambia el nombre del archivo RAW a disk.img y asigna los permisos necesarios.

* Importa los volúmenes como PVC utilizando la importación de Trident.
+
Posteriormente, los volúmenes se importan como PVC utilizando las API de NetApp Trident .

* Crea máquinas virtuales utilizando archivos YAML específicos para cada máquina virtual.
+
Una vez importados los PVC y colocados los PV, Shift Toolkit utiliza OC CLI para crear cada VM según el sistema operativo mediante archivos yaml.




NOTE: Las máquinas virtuales se crean bajo el espacio de nombres "Predeterminado".

* Enciende las máquinas virtuales en el destino
+
Dependiendo del sistema operativo de la máquina virtual, Shift Toolkit asigna automáticamente la opción de arranque de la máquina virtual junto con las interfaces del controlador de almacenamiento.  Para las distribuciones de Linux, se utiliza VirtIO o VirtIO SCSI.  En Windows, la máquina virtual se enciende con la interfaz SATA, luego el script programado instala automáticamente los controladores VirtIO y cambia la interfaz a VirtIO.

* Registra las redes en cada máquina virtual.
+
Las redes se asignan en función de la selección del plano.

* Elimina las herramientas de VMware y asigna direcciones IP mediante tareas cron.


.Mostrar ejemplo
[%collapsible]
====
image::shift-toolkit-115.png[Migración de máquinas virtuales de Red Hat OpenShift]

====


== Utilice Migration Toolkit para la virtualización con Shift Toolkit

Esta sección describe cómo usar Migration Toolkit for Virtualization (MTV) con NetApp Shift Toolkit para una migración sin problemas a Red Hat OpenShift Virtualization.

.Antes de empezar
Asegúrese de que se cumplan los siguientes requisitos previos:

* Clúster de OpenShift con operador de virtualización de OpenShift y controlador CSI de NetApp Trident instalado
* MTV 2.9.4 (que incluye el modo de conversión)
* link:https://mysupport.netapp.com/site/tools/tool-eula/netapp-shift-toolkit["Kit de herramientas Shift"]instalado
+

NOTE: Dado que solo se utiliza la API de Shift Toolkit, no es necesario configurar los grupos de recursos ni los planos de Shift Toolkit.

* Privilegios de nivel administrador en el clúster de OpenShift
* Una instancia de Linux con tridentctl y la herramienta de línea de comandos OC instaladas
+
** Se exportó Kubeconfig o se ejecutó OC login para conectarse al clúster.
** Descarga el script llamado "OpenShift-MTV" desde la interfaz de usuario de Shift Toolkit (*Configuración > Acceso para desarrolladores > Bloqueador de scripts*).
** Descomprime el archivo: `unzip openshift-mtv.zip`
** Asegúrese de tener instalado Python 3: `dnf install python3`
** Instala OpenJDK 8 o posterior: `yum install java-1.8.0-openjdk`
** Requisitos de instalación: `pip install -r requirements.txt`


* *Requisitos de máquina virtual para MTV*: Los VMDK para una máquina virtual deben colocarse en volúmenes individuales.  Para una máquina virtual con 3 discos, cada disco debe estar en su propio volumen (asignando el almacén de datos a la estructura PVC).  Esto debe hacerse manualmente utilizando Storage vMotion.


.Pasos
. Crea planes de migración utilizando MTV.
+
Para aprovechar la conversión rápida de VMDK, cree un plan de migración para las máquinas virtuales y asegúrese de que los siguientes parámetros estén en el archivo YAML:

+
** `targetNamespace: default`
** `type: conversion`
** `storage: {}`
+

NOTE: El plan debe crearse con antelación para garantizar que MTV configure correctamente los ajustes de IP.



. Asignar máquinas virtuales desde vCenter y volúmenes en almacenamiento ONTAP .
+
Utilice el script para crear los PVC necesarios e importarlos al clúster de OpenShift.  Los PVC deben tener las siguientes etiquetas y anotaciones:

+
*Etiquetas:*

+
** vmID y vmUUID en el PVC (Forklift busca estos valores)
+
*Anotación:*

** El nombre del disco vmdk para `forklift.konveyor.io/disk-source`
+
El script garantiza que estos atributos estén configurados para cada PVC y actualiza los permisos de disk.img:

** `"owner": { "id": 107 }`
** `"group": { "id": 107 }`
** `"mode": "0655"`


. Actualiza el archivo JSON con los siguientes detalles:
+
** * Clúster ONTAP *: Puede ser una SVM; se puede usar vsadmin.  Establezca splitclone en "False" si el volumen clonado no necesita una separación inmediata.
** *vCenter*: Derechos RBAC mínimos para detectar máquinas virtuales y archivos VMDK asociados.
** *Clase de almacenamiento Trident *: Debe ser un backend NFS con la versión correcta en YAML.
** *OpenShift*: Especifique el nombre del proyecto (se utiliza el valor predeterminado como ejemplo).
+

NOTE: Mantén el resto de los valores como predeterminados.



. Una vez que se cumplan los requisitos previos, ejecute `python3 main.py` para crear PVC e importarlos al clúster de OpenShift.
. Una vez importados los PVC, active la migración utilizando MTV para crear la máquina virtual con la especificación adecuada.
+
.Mostrar ejemplo
[%collapsible]
====
image::shift-toolkit-116.png[Ejecución de script de Python]

====
+
.Mostrar ejemplo
[%collapsible]
====
image::shift-toolkit-117.png[Resultados en Shift Toolkit]

====
. Convertir VMDK con MTV.
+
El script encuentra automáticamente todos los VMDK asociados a cada máquina virtual, incluido el disco de arranque principal.

+

NOTE: Si existen varios archivos VMDK, cada uno de ellos será convertido.

. Subir imagen RAW a OpenShift Virtualization.
+
El script utiliza Trident CSI para importar volúmenes como PVC al clúster.  El archivo YAML del PVC se completa con etiquetas y anotaciones.

. Crea una máquina virtual con MTV.
+
Después de la importación, llame al plan de MTV para iniciar la migración.  La interfaz de usuario se muestra como "Fría", pero según la especificación yaml de conversión, MTV verifica cada PVC y el vmID/vmUUID, los asigna e inicializa la migración.

+
.Mostrar ejemplo
[%collapsible]
====
image::shift-toolkit-118.png[estado migratorio]

====
+

NOTE: Las máquinas virtuales se crean bajo el proyecto "Predeterminado" para máquinas virtuales, pero esto se puede modificar dentro del archivo YAML del plan de migración de MTV.

. Iniciar la máquina virtual por primera vez con MTV.
+
Dependiendo del sistema operativo de la máquina virtual, MTV asigna automáticamente la opción de arranque de la máquina virtual junto con las interfaces del controlador de almacenamiento.

+
.Mostrar ejemplo
[%collapsible]
====
image::shift-toolkit-119.png[Historia de la migración]

====
+
La migración se completó en 6 minutos para una máquina virtual con un disco de datos de 1,5 TB (distribuido en 3 PVC).  Esto muestra un enfoque simplificado y de bajo impacto para reubicar máquinas virtuales utilizando almacenamiento ONTAP .

+

NOTE: Antes de comenzar con esta integración específica, póngase en contacto con su equipo de cuenta de Red Hat.





== Demostración en vídeo

El siguiente vídeo muestra el proceso descrito en esta solución.

.Migración sin intervención desde ESX a Oracle Linux Virtualization Manager (OLVM)
video::7e2abc5e-2919-43d6-a5c2-b3760100adaf[panopto]